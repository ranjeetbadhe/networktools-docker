pipeline {
    agent any

    environment {
        REGISTRY      = "docker.io"
        DOCKERHUB_USER = "badheranjeet"
        IMAGE_NAME    = "networktools"
        IMAGE_VERSION = "v1"  // bump manually when needed
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Image') {
            steps {
                script {
                    // short git commit as part of the tag
                    def GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()

                    env.IMAGE_TAG_FULL = "${IMAGE_VERSION}-${GIT_COMMIT_SHORT}"
                    echo "Building image tag: ${IMAGE_TAG_FULL}"

                    sh """
                      docker build -t ${REGISTRY}/${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG_FULL} .
                    """

                    // Also tag as version-only and latest
                    sh """
                      docker tag ${REGISTRY}/${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG_FULL} ${REGISTRY}/${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_VERSION}
                      docker tag ${REGISTRY}/${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG_FULL} ${REGISTRY}/${DOCKERHUB_USER}/${IMAGE_NAME}:latest
                    """
                }
            }
        }

        stage('Push Image to DockerHub') {
            steps {
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-creds',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                          echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin ${REGISTRY}
                          docker push ${REGISTRY}/${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG_FULL}
                          docker push ${REGISTRY}/${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_VERSION}
                          docker push ${REGISTRY}/${DOCKERHUB_USER}/${IMAGE_NAME}:latest
                          docker logout ${REGISTRY}
                        """
                    }
                }
            }
        }
    }
}

